<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Site.Title }}</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <style type="text/tailwindcss">
        @custom-variant dark (&:where(.dark, .dark *));
        @custom-variant light (&:where(.light, .light *));
        
        body { 
            background-color: #0f172a; 
            color: white;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .dark body { background-color: #0f172a; color: white; }
        .light body { background-color: #f1f5f9; color: #0f172a; }
        
        /* Full height layout using flexbox */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
        }
        
        .map-container {
            flex: 1;
            min-height: 0;
        }
        
        #map { 
            height: 100%;
            width: 100%; 
            border-radius: 0.75rem; 
            border: 1px solid #334155;
            box-shadow: 0 0 40px rgba(0, 209, 95, 0.08), 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        @media (max-width: 640px) {
            #map { 
                border-radius: 0;
                border-left: none;
                border-right: none;
            }
        }
        .light #map { 
            border: 1px solid #cbd5e1;
            box-shadow: 0 0 40px rgba(0, 120, 212, 0.08), 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        /* Pulse animation for markers */
        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.3); opacity: 0.4; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        
        /* Header gradient */
        .header-gradient {
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
        }
        .light .header-gradient {
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
        }

        /* Select dropdown styling */
        select {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        select:hover {
            border-color: #00d15f !important;
        }
        .light select:hover {
            border-color: #0078D4 !important;
        }

        /* Multi-select dropdown */
        .multiselect {
            position: relative;
            display: inline-block;
        }
        .multiselect-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .multiselect-btn:hover {
            border-color: #00d15f !important;
        }
        .light .multiselect-btn:hover {
            border-color: #0078D4 !important;
        }
        .multiselect-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            min-width: 180px;
            margin-top: 4px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.2s ease;
        }
        .multiselect-dropdown.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .light .multiselect-dropdown {
            background: white;
            border-color: #e2e8f0;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .multiselect-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: background 0.15s ease;
            font-size: 0.75rem;
        }
        .multiselect-option:first-child {
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .multiselect-option:last-child {
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .multiselect-option:hover {
            background: #334155;
        }
        .light .multiselect-option:hover {
            background: #f1f5f9;
        }
        .multiselect-option input[type="checkbox"] {
            accent-color: #00d15f;
            width: 14px;
            height: 14px;
            cursor: pointer;
        }
        .multiselect-chevron {
            transition: transform 0.2s ease;
        }
        .multiselect-btn[aria-expanded="true"] .multiselect-chevron {
            transform: rotate(180deg);
        }

        /* Theme toggle button */
        #themeToggle {
            transition: all 0.2s ease;
        }
        #themeToggle:hover {
            transform: scale(1.05);
        }
        #themeToggle:active {
            transform: scale(0.95);
        }

        /* Leaflet popup - dark mode (default and explicit .dark) */
        .leaflet-popup-content-wrapper {
            background: #1e293b !important;
            color: white !important;
            border: 1px solid #475569 !important;
            padding: 0;
            border-radius: 0.75rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.05) !important;
            animation: popup-fade-in 0.2s ease-out;
        }
        @keyframes popup-fade-in {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .leaflet-popup-tip {
            background: #1e293b !important;
            border: 1px solid #475569 !important;
            box-shadow: none !important;
        }
        .leaflet-container a.leaflet-popup-close-button {
            color: #94a3b8 !important;
            transition: color 0.2s ease, transform 0.2s ease;
            font-size: 20px !important;
            width: 24px !important;
            height: 24px !important;
            padding: 4px !important;
        }
        .leaflet-container a.leaflet-popup-close-button:hover {
            color: #f87171 !important;
            transform: scale(1.1);
        }
        
        /* Leaflet popup - light mode */
        .light .leaflet-popup-content-wrapper {
            background: white !important;
            color: #0f172a !important;
            border: 1px solid #e2e8f0 !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05) !important;
        }
        .light .leaflet-popup-tip {
            background: white !important;
            border: 1px solid #e2e8f0 !important;
        }
        .light .leaflet-container a.leaflet-popup-close-button {
            color: #64748b !important;
        }
        
        .leaflet-popup-content {
            margin: 0 !important;
            width: auto !important;
        }
        
        /* Mobile popup adjustments */
        @media (max-width: 640px) {
            .leaflet-popup-content-wrapper {
                max-width: calc(100vw - 40px) !important;
            }
            .leaflet-popup {
                max-width: calc(100vw - 20px) !important;
            }
        }
        
        /* Popup inner content - light mode overrides */
        .light .leaflet-popup-content h3 { color: #0f172a !important; }
        .light .leaflet-popup-content .bg-slate-900\/50,
        .light .leaflet-popup-content .bg-slate-900\/60 { 
            background: #f1f5f9 !important; 
            border-color: #e2e8f0 !important; 
        }
        .light .leaflet-popup-content .bg-slate-800,
        .light .leaflet-popup-content .bg-slate-800\/80 { 
            background: #ffffff !important; 
            border-color: #e2e8f0 !important;
        }
        .light .leaflet-popup-content .bg-slate-700\/50,
        .light .leaflet-popup-content .bg-slate-700\/60,
        .light .leaflet-popup-content .bg-gradient-to-r { 
            background: #f1f5f9 !important; 
        }
        .light .leaflet-popup-content .border-slate-700,
        .light .leaflet-popup-content .border-slate-700\/50,
        .light .leaflet-popup-content .border-slate-700\/30 { 
            border-color: #e2e8f0 !important; 
        }
        .light .leaflet-popup-content .text-white { color: #0f172a !important; }
        .light .leaflet-popup-content .text-slate-300 { color: #334155 !important; }
        .light .leaflet-popup-content .text-slate-400 { color: #475569 !important; }
        .light .leaflet-popup-content .text-slate-500 { color: #64748b !important; }
        
        /* Light mode service icon wrapper hover */
        .light .leaflet-popup-content .service-icon-wrapper:hover {
            background: rgba(0, 0, 0, 0.05) !important;
        }
        
        /* Light mode badge adjustments */
        .light .leaflet-popup-content .text-green-400 { color: #16a34a !important; }
        .light .leaflet-popup-content .bg-green-500\/10 { background: rgba(22, 163, 74, 0.1) !important; }
        .light .leaflet-popup-content .border-green-500\/30 { border-color: rgba(22, 163, 74, 0.3) !important; }
        .light .leaflet-popup-content .text-blue-400 { color: #2563eb !important; }
        .light .leaflet-popup-content .bg-blue-500\/10 { background: rgba(37, 99, 235, 0.1) !important; }
        .light .leaflet-popup-content .border-blue-500\/30 { border-color: rgba(37, 99, 235, 0.3) !important; }
        .light .leaflet-popup-content .text-amber-400 { color: #d97706 !important; }
        .light .leaflet-popup-content .bg-amber-500\/10 { background: rgba(217, 119, 6, 0.1) !important; }
        .light .leaflet-popup-content .border-amber-500\/30 { border-color: rgba(217, 119, 6, 0.3) !important; }

        /* Legend styling */
        .legend-container {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .legend-container:hover {
            transform: translateY(-2px);
        }

        /* Service icon hover effect */
        .service-icon-wrapper {
            transition: transform 0.2s ease;
        }
        .service-icon-wrapper:hover {
            transform: scale(1.1);
        }

        /* Zoom controls */
        .leaflet-control-zoom a {
            transition: all 0.2s ease !important;
        }
        .leaflet-control-zoom a:hover {
            transform: scale(1.05);
        }

        /* Info panel */
        #infoPanel {
            scrollbar-width: thin;
            scrollbar-color: #475569 transparent;
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
        }
        #infoPanel::-webkit-scrollbar {
            width: 6px;
        }
        #infoPanel::-webkit-scrollbar-track {
            background: transparent;
        }
        #infoPanel::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        .light #infoPanel {
            scrollbar-color: #cbd5e1 transparent;
        }
        .light #infoPanel::-webkit-scrollbar-thumb {
            background: #cbd5e1;
        }
        #infoPanelOverlay.open {
            opacity: 1;
        }
        #infoPanel.open {
            transform: translateX(0);
        }

        /* Info button hover effect */
        #infoBtn {
            transition: all 0.2s ease;
        }
        #infoBtn:hover {
            transform: scale(1.05);
        }
        #infoBtn:active {
            transform: scale(0.95);
        }

        /* Custom cluster marker styles */
        .marker-cluster {
            background: transparent !important;
        }
        .marker-cluster div {
            background: transparent !important;
        }
        .custom-cluster-marker {
            background: transparent !important;
        }
        .cluster-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: 700;
            font-size: 12px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), 0 0 0 3px rgba(255, 255, 255, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }
        .cluster-marker:hover {
            transform: scale(1.15);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4), 0 0 0 4px rgba(255, 255, 255, 0.2);
        }
        .cluster-small {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 2px solid #00d15f;
            font-size: 11px;
        }
        .cluster-medium {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            border: 2px solid #10b981;
            font-size: 13px;
        }
        .cluster-large {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #047857 0%, #00d15f 100%);
            border: 3px solid #34d399;
            font-size: 14px;
        }
        /* Provider indicator bar at bottom of cluster */
        .cluster-providers {
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
            border-radius: 4px;
            overflow: hidden;
        }
        .cluster-providers .azure-bar {
            height: 4px;
            background: #0078D4;
        }
        .cluster-providers .aws-bar {
            height: 4px;
            background: #FF9900;
        }
        /* Light mode cluster styles */
        .light .cluster-small {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-color: #16a34a;
            color: #0f172a;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15), 0 0 0 3px rgba(0, 0, 0, 0.05);
        }
        .light .cluster-medium {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #059669;
            color: #064e3b;
        }
        .light .cluster-large {
            background: linear-gradient(135deg, #6ee7b7 0%, #34d399 100%);
            border-color: #047857;
            color: #022c22;
        }
        .light .cluster-marker:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2), 0 0 0 4px rgba(0, 0, 0, 0.1);
        }
        /* Cluster spiderfy leg styles */
        .leaflet-cluster-anim .leaflet-marker-icon, .leaflet-cluster-anim .leaflet-marker-shadow {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }

        /* Loading overlay */
        #mapLoading {
            transition: opacity 0.3s ease-out;
        }
        #mapLoading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        /* Error state */
        #mapError {
            display: none;
        }
        #mapError.visible {
            display: flex;
        }

        /* Search input and dropdown */
        .search-container {
            position: relative;
        }
        #regionSearch {
            transition: all 0.2s ease;
            width: 140px;
        }
        #regionSearch:focus {
            width: 200px;
        }
        @media (max-width: 640px) {
            #regionSearch, #regionSearch:focus {
                width: 120px;
            }
        }
        #searchResults {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            min-width: 250px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 4px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.2s ease;
        }
        #searchResults.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .light #searchResults {
            background: white;
            border-color: #e2e8f0;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .search-result-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            cursor: pointer;
            transition: background 0.15s ease;
            border-bottom: 1px solid #334155;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .search-result-item:hover, .search-result-item.highlighted {
            background: #334155;
        }
        .light .search-result-item {
            border-bottom-color: #e2e8f0;
        }
        .light .search-result-item:hover, .light .search-result-item.highlighted {
            background: #f1f5f9;
        }
        .search-result-item .provider-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .search-result-item .region-name {
            font-size: 0.875rem;
            color: white;
            font-weight: 500;
        }
        .light .search-result-item .region-name {
            color: #0f172a;
        }
        .search-result-item .match-text {
            font-size: 0.75rem;
            color: #94a3b8;
        }
        .search-no-results {
            padding: 1rem;
            text-align: center;
            color: #94a3b8;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="font-sans antialiased">
<div class="app-container overflow-hidden">
    <header class="header-gradient border-b border-slate-800/50 light:border-slate-200 flex flex-col justify-center px-3 sm:px-6 lg:px-8 py-2 sm:py-3 flex-shrink-0">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 sm:gap-4 max-w-[1800px] mx-auto w-full">
            <div class="flex items-center gap-2 sm:gap-3">
                <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center shadow-lg shadow-green-500/20 flex-shrink-0">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                    </svg>
                </div>
                <div class="min-w-0">
                    <h1 class="text-lg sm:text-2xl font-bold truncate">
                        <span class="bg-gradient-to-r from-green-400 to-emerald-500 bg-clip-text text-transparent">Veeam Data Cloud</span>
                        <span class="text-white light:text-slate-900"> Service Map</span>
                    </h1>
                    <p class="text-[10px] sm:text-xs text-slate-400 light:text-slate-500 tracking-wide hidden sm:block">Interactive Global Availability</p>
                </div>
            </div>

            <div class="flex gap-1.5 sm:gap-2 lg:gap-3 items-center flex-wrap">
                <!-- Search Input -->
                <div class="search-container">
                    <div class="relative">
                        <svg class="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <input type="text" id="regionSearch" placeholder="Search regions..." autocomplete="off"
                               role="combobox"
                               aria-expanded="false"
                               aria-controls="searchResults"
                               aria-autocomplete="list"
                               aria-activedescendant=""
                               class="bg-slate-800/80 light:bg-white border border-slate-600/50 light:border-slate-300 rounded-lg pl-8 pr-3 py-1.5 sm:py-2 text-xs sm:text-sm text-white light:text-slate-900 placeholder-slate-400 light:placeholder-slate-500 focus:ring-2 focus:ring-green-500/50 focus:border-green-500 outline-none shadow-sm backdrop-blur-sm">
                    </div>
                    <div id="searchResults" role="listbox" aria-label="Search results"></div>
                </div>

                <select id="providerFilter" class="bg-slate-800/80 light:bg-white border border-slate-600/50 light:border-slate-300 rounded-lg px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm text-white light:text-slate-900 focus:ring-2 focus:ring-green-500/50 focus:border-green-500 outline-none shadow-sm backdrop-blur-sm min-w-0">
                    <option value="all">All Providers</option>
                    <option value="Azure">Azure</option>
                    <option value="AWS">AWS</option>
                </select>

                <div class="multiselect" id="serviceMultiselect">
                    <button type="button" id="serviceFilterBtn" aria-expanded="false" class="multiselect-btn bg-slate-800/80 light:bg-white border border-slate-600/50 light:border-slate-300 rounded-lg px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm text-white light:text-slate-900 shadow-sm backdrop-blur-sm min-w-0">
                        <span id="serviceFilterLabel">All Services</span>
                        <svg class="multiselect-chevron w-3 h-3 sm:w-4 sm:h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="multiselect-dropdown" id="serviceDropdown">
                        <label class="multiselect-option text-white light:text-slate-900">
                            <input type="checkbox" value="vdc_vault"> Vault
                        </label>
                        <label class="multiselect-option text-white light:text-slate-900">
                            <input type="checkbox" value="vdc_m365"> M365
                        </label>
                        <label class="multiselect-option text-white light:text-slate-900">
                            <input type="checkbox" value="vdc_entra_id"> Entra ID
                        </label>
                        <label class="multiselect-option text-white light:text-slate-900">
                            <input type="checkbox" value="vdc_salesforce"> Salesforce
                        </label>
                        <label class="multiselect-option text-white light:text-slate-900">
                            <input type="checkbox" value="vdc_azure_backup"> Azure
                        </label>
                    </div>
                </div>

                <div id="regionCount" class="hidden sm:flex items-center gap-1.5 px-3 py-1.5 bg-slate-800/60 light:bg-slate-100 rounded-lg border border-slate-600/30 light:border-slate-300 text-xs text-slate-300 light:text-slate-600">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span><span id="visibleCount" class="font-semibold text-white light:text-slate-900">0</span> of <span id="totalCount" class="font-semibold">0</span> regions</span>
                </div>

                <button id="resetFilters" class="hidden items-center gap-1.5 px-2.5 py-1.5 rounded-lg bg-amber-500/20 light:bg-amber-100 border border-amber-500/40 light:border-amber-400 text-amber-400 light:text-amber-700 hover:bg-amber-500/30 light:hover:bg-amber-200 text-xs font-medium transition-all duration-200 flex-shrink-0" title="Reset all filters">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    <span class="hidden sm:inline">Reset</span>
                </button>

                <button id="themeToggle" class="p-2 sm:p-2.5 rounded-lg bg-slate-800/80 light:bg-white border border-slate-600/50 light:border-slate-300 hover:bg-slate-700 light:hover:bg-slate-100 hover:border-green-500/50 shadow-sm backdrop-blur-sm flex-shrink-0" title="Toggle theme">
                    <svg id="iconSystem" class="w-4 h-4 sm:w-5 sm:h-5 text-slate-300 light:text-slate-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l.123.489.804.804A1 1 0 0113 18H7a1 1 0 01-.707-1.707l.804-.804L7.22 15H5a2 2 0 01-2-2V5zm5.771 7H5V5h10v7H8.771z" clip-rule="evenodd"/>
                    </svg>
                    <svg id="iconLight" class="w-4 h-4 sm:w-5 sm:h-5 text-yellow-400 hidden" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                    </svg>
                    <svg id="iconDark" class="w-4 h-4 sm:w-5 sm:h-5 text-slate-300 hidden" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                    </svg>
                </button>

                <button id="infoBtn" class="p-2 sm:p-2.5 rounded-lg bg-slate-800/80 light:bg-white border border-slate-600/50 light:border-slate-300 hover:bg-slate-700 light:hover:bg-slate-100 hover:border-green-500/50 shadow-sm backdrop-blur-sm flex-shrink-0" title="About this map" aria-label="Open about panel" aria-expanded="false" aria-controls="infoPanel">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 text-slate-300 light:text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <div class="map-container p-0 sm:p-4 lg:p-6 bg-gradient-to-b from-slate-950 to-slate-900 light:from-slate-100 light:to-slate-50 transition-colors duration-300 relative">
        <div id="map"></div>
        
        <div id="mapLoading" class="absolute inset-0 sm:m-4 lg:m-6 flex items-center justify-center bg-slate-900/90 light:bg-slate-100/90 backdrop-blur-sm rounded-xl z-[1000]">
            <div class="flex flex-col items-center gap-3">
                <svg class="loading-spinner w-10 h-10 text-green-500" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-slate-300 light:text-slate-600 text-sm font-medium">Loading map...</span>
            </div>
        </div>
        
        <div id="mapError" class="absolute inset-0 sm:m-4 lg:m-6 items-center justify-center bg-slate-900 light:bg-slate-100 rounded-xl z-[1000]">
            <div class="flex flex-col items-center gap-4 p-6 text-center">
                <div class="w-16 h-16 rounded-full bg-red-500/10 flex items-center justify-center">
                    <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white light:text-slate-900 mb-1">Failed to Load Map</h3>
                    <p class="text-slate-400 light:text-slate-500 text-sm max-w-xs">There was a problem loading the map. Please check your internet connection and try refreshing the page.</p>
                </div>
                <button onclick="location.reload()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors">
                    Refresh Page
                </button>
            </div>
        </div>
    </div>
</div>

<div id="infoPanelOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[2000] hidden opacity-0 transition-opacity duration-300"></div>

<div id="infoPanel" class="fixed top-0 right-0 h-full w-full sm:w-96 max-w-full bg-slate-900 light:bg-white border-l border-slate-700 light:border-slate-200 shadow-2xl z-[2001] overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="infoPanelTitle">
    <div class="p-4 sm:p-5">
        <div class="flex items-center justify-between mb-4">
            <h2 id="infoPanelTitle" class="text-xl font-bold text-white light:text-slate-900">About This Map</h2>
            <button id="closeInfoPanel" class="p-2 rounded-lg hover:bg-slate-800 light:hover:bg-slate-100 transition-colors" aria-label="Close panel">
                <svg class="w-5 h-5 text-slate-400 light:text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <div class="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3 mb-4">
            <div class="flex gap-2.5">
                <svg class="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <div>
                    <p class="text-amber-400 font-semibold text-sm">Community Project</p>
                    <p class="text-slate-400 light:text-slate-500 text-xs mt-1">This is an unofficial, community-maintained project. Not affiliated with or endorsed by Veeam Software. Data may be incomplete or outdated.</p>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <h3 class="text-sm font-semibold text-slate-400 light:text-slate-500 uppercase tracking-wider mb-2">What is this?</h3>
            <p class="text-slate-300 light:text-slate-600 text-sm leading-relaxed">
                An interactive map visualizing Veeam Data Cloud (VDC) service availability across AWS and Azure regions. Quickly find where services like VDC Vault, M365 Protection, and more are available.
            </p>
        </div>

        <div class="grid grid-cols-2 gap-2.5 mb-4">
            <div class="bg-slate-800/50 light:bg-slate-100 rounded-lg p-3 border border-slate-700/50 light:border-slate-200">
                <div class="text-2xl font-bold text-white light:text-slate-900" id="infoTotalRegions">0</div>
                <div class="text-xs text-slate-400 light:text-slate-500">Total Regions</div>
            </div>
            <div class="bg-slate-800/50 light:bg-slate-100 rounded-lg p-3 border border-slate-700/50 light:border-slate-200">
                <div class="text-2xl font-bold text-white light:text-slate-900">5</div>
                <div class="text-xs text-slate-400 light:text-slate-500">Services Tracked</div>
            </div>
        </div>

        <div class="mb-4">
            <h3 class="text-sm font-semibold text-slate-400 light:text-slate-500 uppercase tracking-wider mb-2">Maintained By</h3>
            <a href="https://github.com/comnam90" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 p-2.5 rounded-lg bg-slate-800/50 light:bg-slate-100 border border-slate-700/50 light:border-slate-200 hover:border-green-500/50 transition-colors group">
                <div class="w-9 h-9 rounded-full bg-gradient-to-br from-green-400 to-emerald-600 flex items-center justify-center text-white font-bold text-sm">C</div>
                <div>
                    <div class="text-white light:text-slate-900 font-medium group-hover:text-green-400 transition-colors">@comnam90</div>
                    <div class="text-xs text-slate-400 light:text-slate-500">GitHub</div>
                </div>
                <svg class="w-4 h-4 text-slate-500 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
            </a>
        </div>

        <div class="mb-4">
            <h3 class="text-sm font-semibold text-slate-400 light:text-slate-500 uppercase tracking-wider mb-2">Quick Links</h3>
            <div class="space-y-1.5">
                <a href="https://github.com/comnam90/veeam-data-cloud-services-map" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2.5 p-2.5 rounded-lg bg-slate-800/50 light:bg-slate-100 border border-slate-700/50 light:border-slate-200 hover:border-green-500/50 transition-colors group">
                    <svg class="w-5 h-5 text-slate-400 group-hover:text-green-400 transition-colors" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                    <span class="text-slate-300 light:text-slate-600 text-sm group-hover:text-green-400 transition-colors">View on GitHub</span>
                    <svg class="w-4 h-4 text-slate-500 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                    </svg>
                </a>
                <a href="https://www.veeam.com/products/veeam-data-cloud.html" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2.5 p-2.5 rounded-lg bg-slate-800/50 light:bg-slate-100 border border-slate-700/50 light:border-slate-200 hover:border-green-500/50 transition-colors group">
                    <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 144 144">
                        <path d="M118.21 117.2c0 .49-.2.94-.53 1.27-.33.32-.77.53-1.27.53l-21.51.11v12.01H105c3.21 0 6.3-1.28 8.57-3.55l13.2-13.2c2.27-2.27 3.55-5.36 3.55-8.57V94.65h-12.11v22.56zM25.79 26.8c0-.49.2-.94.53-1.27.32-.32.77-.53 1.27-.53l21.51-.11V12.88H39c-3.21 0-6.3 1.28-8.57 3.55l-13.2 13.2a12.14 12.14 0 0 0-3.55 8.57v11.15h12.11V26.79zm-.47 90.68a1.8 1.8 0 0 1-.52-1.27l-.11-21.51H12.68v10.1c0 3.21 1.28 6.3 3.55 8.57l13.2 13.2c2.27 2.27 5.36 3.55 8.57 3.55h11.15v-12.11H26.59c-.49-.01-.94-.21-1.27-.54zm102.46-86.86-13.2-13.2a12.14 12.14 0 0 0-8.57-3.55H94.86v12.11h22.56c.49.01.94.21 1.27.54.32.32.52.77.52 1.27l.11 21.51h12.01V39.2c0-3.21-1.28-6.3-3.55-8.57zM71.86 78.79a6.65 6.65 0 1 0 0-13.3 6.65 6.65 0 0 0 0 13.3"/>
                    </svg>
                    <span class="text-slate-300 light:text-slate-600 text-sm group-hover:text-green-400 transition-colors">Official Veeam Data Cloud</span>
                    <svg class="w-4 h-4 text-slate-500 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                    </svg>
                </a>
            </div>
        </div>

        <div class="mb-4">
            <h3 class="text-sm font-semibold text-slate-400 light:text-slate-500 uppercase tracking-wider mb-2">Found an Issue?</h3>
            <div class="space-y-1.5">
                <a href="https://github.com/comnam90/veeam-data-cloud-services-map/issues/new?template=missing-service.yml" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2.5 p-2.5 rounded-lg bg-blue-500/10 border border-blue-500/30 hover:bg-blue-500/20 transition-colors group">
                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="text-blue-400 text-sm font-medium">Report Missing Service</span>
                </a>
                <a href="https://github.com/comnam90/veeam-data-cloud-services-map/issues/new?template=missing-region.yml" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2.5 p-2.5 rounded-lg bg-purple-500/10 border border-purple-500/30 hover:bg-purple-500/20 transition-colors group">
                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span class="text-purple-400 text-sm font-medium">Report Missing Region</span>
                </a>
                <a href="https://github.com/comnam90/veeam-data-cloud-services-map/issues/new?template=incorrect-information.yml" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2.5 p-2.5 rounded-lg bg-amber-500/10 border border-amber-500/30 hover:bg-amber-500/20 transition-colors group">
                    <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <span class="text-amber-400 text-sm font-medium">Report Incorrect Info</span>
                </a>
            </div>
        </div>

        <div class="pt-3 border-t border-slate-700/50 light:border-slate-200">
            {{ with .Lastmod }}{{ if not .IsZero }}
            <p class="text-xs text-slate-400 light:text-slate-500 text-center mb-2">
                Last updated: {{ .Format "January 2, 2006" }}
            </p>
            {{ end }}{{ end }}
            <p class="text-xs text-slate-500 light:text-slate-400 text-center">
                Built with Hugo, Leaflet.js & Tailwind CSS
            </p>
        </div>
    </div>
</div>

    <script>
        const DEBUG = false;

        // Hugo injects YAML data as JSON; may produce strings instead of arrays in some edge cases
        const rawRegions = [
            {{ range $provider, $regions := .Site.Data.regions }}
            {{ range $key, $data := $regions }}
            {
                id: "{{ $key }}",
                name: "{{ $data.name }}",
                provider: "{{ $data.provider }}",
                coords: {{ $data.coords | jsonify }}, 
                services: {{ $data.services | jsonify }},
                aliases: {{ $data.aliases | default (slice) | jsonify }}
            },
            {{ end }}
            {{ end }}
        ];

        function ensureArray(input) {
            if (!input) return [];
            if (Array.isArray(input)) return input;
            if (typeof input === 'string') {
                try {
                    const parsed = JSON.parse(input);
                    return Array.isArray(parsed) ? parsed : [input];
                } catch(e) {
                    return [input];
                }
            }
            return [input];
        }

        // Normalize data types to handle YAML edge cases like coords: "[-33, 151]" as string
        const regions = rawRegions.map(region => {
            let cleanCoords = region.coords;
            let cleanServices = region.services;

            if (typeof cleanCoords === 'string') {
                try { 
                    cleanCoords = JSON.parse(cleanCoords); 
                } catch(e) {
                    if (cleanCoords.includes(',')) cleanCoords = cleanCoords.split(',').map(Number);
                }
            }

            if (typeof cleanServices === 'string') {
                try { 
                    cleanServices = JSON.parse(cleanServices); 
                } catch(e) { 
                    console.error("Bad JSON in services for:", region.name); 
                    cleanServices = {}; 
                }
            }

            return {
                ...region,
                coords: cleanCoords,
                services: cleanServices || {},
                aliases: ensureArray(region.aliases)
            };
        });

        if (DEBUG) console.log("Processed Regions Data:", regions);

        function getServiceIcon(serviceKey) {
            const icons = {
                'vdc_entra_id': `<svg class="w-6 h-6" viewBox="0 0 20 20"><path fill="#225086" d="M4.802 15.032c.388.242 1.033.511 1.715.511.621 0 1.198-.18 1.676-.487h.002L10 13.928v4.073a1.56 1.56 0 0 1-.824-.234z"></path><path fill="#6df" d="m8.853 2.507-7.5 8.46c-.579.654-.428 1.642.323 2.111l3.126 1.954c.388.242 1.033.511 1.715.511.621 0 1.198-.18 1.676-.487h.002L10 13.928 5.636 11.2l4.365-4.924V2c-.424 0-.848.169-1.148.507"></path><path fill="#cbf8ff" d="m5.636 11.199.052.032L10 13.927V6.276z"></path><path fill="#074793" d="M18.324 13.078c.751-.469.902-1.457.323-2.111l-4.921-5.551a3.1 3.1 0 0 0-1.313-.291c-.925 0-1.752.399-2.302 1.026l-.109.123 4.364 4.924-4.365 2.728v4.073c.287 0 .573-.078.823-.234l7.5-4.688Z"></path><path fill="#0294e4" d="M10.001 2v4.275l.109-.123a3.05 3.05 0 0 1 2.302-1.026c.472 0 .916.107 1.313.291l-2.579-2.909A1.52 1.52 0 0 0 10 2.001z"></path><path fill="#96bcc2" d="m14.365 11.199-4.364-4.923v7.65z"></path></svg>`,
                'vdc_m365': `<svg class="w-6 h-6" viewBox="0 0 20 20"><radialGradient id="m365_a" cx="-235.67" cy="-976.437" r="0.242" gradientTransform="matrix(-17.55009 46.87 -81.74998 -30.6106 -83952.58 -18838.056)" gradientUnits="userSpaceOnUse"><stop offset="0.06" stop-color="#ae7fe2"></stop><stop offset="1" stop-color="#0078d4"></stop></radialGradient><radialGradient id="m365_c" cx="-231.163" cy="-948.32" r="0.242" gradientTransform="rotate(-8.37 194093.408 -88191.206)scale(46.576 30.768)" gradientUnits="userSpaceOnUse"><stop offset="0.13" stop-color="#d59dff"></stop><stop offset="1" stop-color="#5e438f"></stop></radialGradient><radialGradient id="m365_e" cx="-259.845" cy="-974.124" r="0.242" gradientTransform="rotate(-165.77 -1022.606 -31253.357)scale(37.387 62.931)" gradientUnits="userSpaceOnUse"><stop offset="0.06" stop-color="#50e6ff"></stop><stop offset="1" stop-color="#436dcd"></stop></radialGradient><linearGradient id="m365_b" x1="9.93" x2="8.198" y1="13.718" y2="10.726" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#114a8b"></stop><stop offset="1" stop-color="#0078d4" stop-opacity="0"></stop></linearGradient><linearGradient id="m365_d" x1="14.178" x2="12.323" y1="9.266" y2="11.927" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#493474"></stop><stop offset="1" stop-color="#8c66ba" stop-opacity="0"></stop></linearGradient><linearGradient id="m365_g" x1="7.446" x2="10.175" y1="7.272" y2="7.272" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#2d3f80"></stop><stop offset="1" stop-color="#436dcd" stop-opacity="0"></stop></linearGradient><path fill="url(#m365_a)" d="m8.577 2.374-.082.048a3 3 0 0 0-.366.262l.242-.165h2l.356 2.754-1.818 1.818-1.818 1.263v1.454c0 1.018.532 1.962 1.403 2.489l1.915 1.159-4.046 2.361h-.781l-1.454-.88a2.91 2.91 0 0 1-1.401-2.489V7.549c0-1.018.532-1.962 1.403-2.489l4.363-2.64.082-.046z"></path><path fill="url(#m365_b)" d="m8.577 2.374-.082.048a3 3 0 0 0-.366.262l.242-.165h2l.356 2.754-1.818 1.818-1.818 1.263v1.454c0 1.018.532 1.962 1.403 2.489l1.915 1.159-4.046 2.361h-.781l-1.454-.88a2.91 2.91 0 0 1-1.401-2.489V7.549c0-1.018.532-1.962 1.403-2.489l4.363-2.64.082-.046z"></path><path fill="url(#m365_c)" d="M12.909 8.182v1.629a2.91 2.91 0 0 1-1.403 2.489l-4.363 2.642c-.89.538-1.998.56-2.909.058l4.261 2.579a2.91 2.91 0 0 0 3.013 0l4.363-2.642a2.91 2.91 0 0 0 1.401-2.489v-1.176l-.364-.545z"></path><path fill="url(#m365_d)" d="M12.909 8.182v1.629a2.91 2.91 0 0 1-1.403 2.489l-4.363 2.642c-.89.538-1.998.56-2.909.058l4.261 2.579a2.91 2.91 0 0 0 3.013 0l4.363-2.642a2.91 2.91 0 0 0 1.401-2.489v-1.176l-.364-.545z"></path><path fill="url(#m365_e)" d="m15.868 5.06-4.363-2.64a2.91 2.91 0 0 0-2.923-.051l-.087.053a2.91 2.91 0 0 0-1.403 2.487v3.449l1.403-.848a2.91 2.91 0 0 1 3.011 0l4.363 2.64a2.9 2.9 0 0 1 1.403 2.395V7.549a2.91 2.91 0 0 0-1.403-2.489z"></path><g fill="url(#m365_g)"><path d="m15.868 5.06-4.363-2.64a2.91 2.91 0 0 0-2.923-.051l-.087.053a2.91 2.91 0 0 0-1.403 2.487v3.449l1.403-.848a2.91 2.91 0 0 1 3.011 0l4.363 2.64a2.9 2.9 0 0 1 1.403 2.395V7.549a2.91 2.91 0 0 0-1.403-2.489z"></path><path d="m15.868 5.06-4.363-2.64a2.91 2.91 0 0 0-2.923-.051l-.087.053a2.91 2.91 0 0 0-1.403 2.487v3.449l1.403-.848a2.91 2.91 0 0 1 3.011 0l4.363 2.64a2.9 2.9 0 0 1 1.403 2.395V7.549a2.91 2.91 0 0 0-1.403-2.489z"></path></g></svg>`, 
                'vdc_vault': `<svg class="w-6 h-6" fill="#00d15f" viewBox="0 0 144 144"><path d="M118.21 117.2c0 .49-.2.94-.53 1.27-.33.32-.77.53-1.27.53l-21.51.11v12.01H105c3.21 0 6.3-1.28 8.57-3.55l13.2-13.2c2.27-2.27 3.55-5.36 3.55-8.57V94.65h-12.11v22.56zM25.79 26.8c0-.49.2-.94.53-1.27.32-.32.77-.53 1.27-.53l21.51-.11V12.88H39c-3.21 0-6.3 1.28-8.57 3.55l-13.2 13.2a12.14 12.14 0 0 0-3.55 8.57v11.15h12.11V26.79zm-.47 90.68a1.8 1.8 0 0 1-.52-1.27l-.11-21.51H12.68v10.1c0 3.21 1.28 6.3 3.55 8.57l13.2 13.2c2.27 2.27 5.36 3.55 8.57 3.55h11.15v-12.11H26.59c-.49-.01-.94-.21-1.27-.54zm102.46-86.86-13.2-13.2a12.14 12.14 0 0 0-8.57-3.55H94.86v12.11h22.56c.49.01.94.21 1.27.54.32.32.52.77.52 1.27l.11 21.51h12.01V39.2c0-3.21-1.28-6.3-3.55-8.57zM71.86 78.79a6.65 6.65 0 1 0 0-13.3 6.65 6.65 0 0 0 0 13.3"></path><path d="m96.29 39.3-8.4 8.4c-4.64-3.09-10.21-4.9-16.19-4.9s-11.26 1.72-15.82 4.66l-8.16-8.16-8.41 8.41 8.08 8.08c-3.14 4.66-4.97 10.28-4.97 16.31s1.81 11.55 4.9 16.19l-8 8 8.41 8.41 8.04-8.04c4.59 2.99 10.07 4.74 15.94 4.74s11.64-1.83 16.31-4.97l8.28 8.28 8.41-8.41-8.37-8.37c2.94-4.57 4.66-10 4.66-15.82s-1.75-11.35-4.74-15.94l8.45-8.45-8.41-8.41zm-8.46 40.13a17.8 17.8 0 0 1-5.67 6.96s-.01 0-.02.01c-.4.29-.81.57-1.23.82l-.04.02c-.43.26-.86.5-1.31.72a17.6 17.6 0 0 1-7.86 1.86c-2.66 0-5.19-.61-7.46-1.67-3.7-1.72-6.7-4.67-8.48-8.33-1.14-2.34-1.8-4.96-1.8-7.74s.68-5.49 1.86-7.86c.22-.45.46-.88.72-1.31 0-.01.02-.03.03-.04.26-.42.53-.83.82-1.23 0 0 0-.01.01-.02 1.79-2.44 4.18-4.4 6.96-5.67 2.24-1.02 4.72-1.61 7.34-1.61 2.78 0 5.4.66 7.74 1.8 3.66 1.79 6.61 4.79 8.33 8.48 1.06 2.27 1.67 4.79 1.67 7.46s-.59 5.1-1.61 7.34z"></path></svg>`, 
                'vdc_salesforce': `<svg class="w-6 h-6" viewBox="0 0 273 191"><g fill="none"><path fill="#0d9dda" d="M113.3 21.2c8.8-9.1 21-14.8 34.5-14.8 18 0 33.6 10 42 24.9 7.3-3.2 15.3-5 23.7-5 32.4 0 58.7 26.5 58.7 59.2s-26.3 59.2-58.7 59.2c-4 0-7.8-.4-11.6-1.2-7.3 13.1-21.4 22-37.4 22-6.7 0-13.1-1.6-18.8-4.3-7.5 17.5-24.8 29.8-45 29.8-21.1 0-39-13.3-45.9-32-3 .6-6.1 1-9.3 1C20.4 160 .1 139.4.1 114.1c0-17 9.1-31.8 22.7-39.8-2.8-6.4-4.3-13.5-4.3-21C18.5 24.1 42.2.5 71.4.5c17 0 32.2 8.1 41.9 20.7"></path><g fill="#fff"><path d="M39.4 99.3c-.2.4.1.5.1.6.5.4 1 .6 1.6.9 2.8 1.5 5.4 1.9 8.1 1.9 5.6 0 9.1-3 9.1-7.7v-.1c0-4.4-3.9-6-7.6-7.2l-.5-.2c-2.8-.9-5.2-1.7-5.2-3.5v-.1c0-1.6 1.4-2.7 3.6-2.7 2.4 0 5.3.8 7.1 1.8 0 0 .5.3.7-.2.1-.3 1-2.8 1.1-3.1s-.1-.5-.3-.6c-2.1-1.3-5-2.1-8-2.1h-.6c-5.1 0-8.7 3.1-8.7 7.5v.1c0 4.7 3.9 6.2 7.6 7.2l.6.2c2.7.8 5 1.5 5 3.4v.1c0 1.7-1.5 3-3.9 3-.9 0-3.9 0-7.2-2.1-.4-.2-.6-.4-.9-.6-.2-.1-.6-.3-.7.3zm81.8 0c-.2.4.1.5.1.6.5.4 1 .6 1.6.9 2.8 1.5 5.4 1.9 8.1 1.9 5.6 0 9.1-3 9.1-7.7v-.1c0-4.4-3.9-6-7.6-7.2l-.5-.2c-2.8-.9-5.2-1.7-5.2-3.5v-.1c0-1.6 1.4-2.7 3.6-2.7 2.4 0 5.3.8 7.1 1.8 0 0 .5.3.7-.2.1-.3 1-2.8 1.1-3.1s-.1-.5-.3-.6c-2.1-1.3-5-2.1-8-2.1h-.6c-5.1 0-8.7 3.1-8.7 7.5v.1c0 4.7 3.9 6.2 7.6 7.2l.6.2c2.7.8 5 1.5 5 3.4v.1c0 1.7-1.5 3-3.9 3-.9 0-3.9 0-7.2-2.1-.4-.2-.6-.4-.9-.6-.1-.1-.6-.2-.7.3zm60.4-14.4c-.5-1.5-1.2-2.9-2.1-4-1-1.1-2.2-2.1-3.6-2.7-1.4-.7-3.1-1-5-1s-3.6.3-5 1-2.6 1.6-3.6 2.7c-.9 1.1-1.7 2.5-2.1 4-.5 1.5-.7 3.2-.7 5s.2 3.5.7 5 1.2 2.9 2.1 4c1 1.1 2.2 2.1 3.6 2.7s3.1 1 5 1 3.6-.3 5-1c1.4-.6 2.6-1.6 3.6-2.7.9-1.1 1.7-2.5 2.1-4 .5-1.5.7-3.2.7-5s-.2-3.5-.7-5m-4.6 5q0 4.05-1.5 6.3c-1.5 2.25-2.5 2.2-4.5 2.2-2.1 0-3.5-.7-4.5-2.2s-1.5-3.6-1.5-6.3.5-4.8 1.5-6.3 2.4-2.2 4.5-2.2 3.6.7 4.5 2.2q1.5 2.25 1.5 6.3m42.9 7.8c-.2-.5-.6-.3-.6-.3-.7.3-1.4.5-2.2.6s-1.6.2-2.6.2c-2.3 0-4-.7-5.3-2s-2-3.5-2-6.4c0-2.6.6-4.6 1.8-6.1 1.1-1.5 2.9-2.3 5.2-2.3 1.9 0 3.4.2 4.9.7 0 0 .4.2.5-.3.4-1.1.7-1.9 1.1-3.2.1-.4-.2-.5-.3-.5-.6-.2-2-.6-3.1-.8-1-.2-2.2-.2-3.5-.2-2 0-3.7.3-5.2 1s-2.8 1.6-3.8 2.7-1.8 2.5-2.3 4-.8 3.2-.8 5c0 3.9 1 7 3.1 9.3s5.2 3.5 9.2 3.5c2.4 0 4.8-.5 6.6-1.2 0 0 .3-.2.2-.6zM243.7 84c-.4-1.5-1.4-3-2-3.7-1-1.1-2-1.9-3-2.3q-1.95-.9-4.5-.9c-2 0-3.8.3-5.2 1-1.5.7-2.7 1.6-3.6 2.8-1 1.2-1.7 2.5-2.1 4.1-.5 1.6-.7 3.2-.7 5s.2 3.5.7 5 1.2 2.9 2.3 4c1 1.1 2.4 2 4 2.6s3.5.9 5.7.9c4.6 0 7-1 7.9-1.6.2-.1.3-.3.1-.8l-1-2.9c-.2-.4-.6-.3-.6-.3-1.1.4-2.7 1.2-6.5 1.2-2.4 0-4.3-.7-5.4-1.9-1.2-1.2-1.7-2.9-1.8-5.2h15.8s.4 0 .5-.4c-.1 0 .4-3-.6-6.6M228 87.3c.2-1.5.6-2.7 1.3-3.7 1-1.5 2.4-2.3 4.5-2.3s3.4.8 4.4 2.3c.7 1 .9 2.3 1 3.7zM117.4 84c-.4-1.5-1.4-3-2-3.7-1-1.1-2-1.9-3-2.3q-1.95-.9-4.5-.9c-2 0-3.8.3-5.2 1-1.5.7-2.7 1.6-3.6 2.8-1 1.2-1.7 2.5-2.1 4.1-.5 1.6-.7 3.2-.7 5s.2 3.5.7 5 1.2 2.9 2.3 4c1 1.1 2.4 2 4 2.6s3.5.9 5.7.9c4.6 0 7-1 7.9-1.6.2-.1.3-.3.1-.8l-1-2.9c-.2-.4-.6-.3-.6-.3-1.1.4-2.7 1.2-6.5 1.2-2.4 0-4.3-.7-5.4-1.9-1.2-1.2-1.7-2.9-1.8-5.2h15.8s.4 0 .5-.4c-.1 0 .4-3-.6-6.6m-15.7 3.3c.2-1.5.6-2.7 1.3-3.7 1-1.5 2.4-2.3 4.5-2.3s3.4.8 4.4 2.3c.6 1 .9 2.3 1 3.7zm-27.8-.8c-.6 0-1.5-.1-2.5-.1a16 16 0 0 0-3.9.5q-1.8.45-3.3 1.5c-1.5 1.05-1.7 1.6-2.3 2.6s-.8 2.3-.8 3.6c0 1.4.2 2.6.7 3.6s1.2 1.8 2.1 2.5c.9.6 2 1.1 3.2 1.4s2.6.4 4.2.4 3.2-.1 4.8-.4c1.5-.3 3.4-.6 4-.8.5-.1 1.1-.3 1.1-.3.4-.1.4-.5.4-.5V86.1c0-3.2-.8-5.5-2.5-7-1.7-1.4-4.1-2.2-7.2-2.2-1.2 0-3.1.2-4.2.4 0 0-3.4.7-4.9 1.8 0 0-.3.2-.1.6l1.1 3c.1.4.5.3.5.3s.1 0 .3-.1c3-1.6 6.9-1.6 6.9-1.6 1.7 0 3 .3 3.9 1s1.3 1.7 1.3 3.8v.7c-1.6-.1-2.8-.3-2.8-.3m-6.3 11.1c-.6-.5-.7-.6-.9-.9-.3-.5-.5-1.2-.5-2.1 0-1.4.5-2.4 1.4-3.1 0 0 1.4-1.2 4.6-1.1 2.3 0 4.3.4 4.3.4V98s-2 .4-4.3.6c-3.2.1-4.6-1-4.6-1"></path><path d="M201.1 78.4c.1-.4-.1-.5-.2-.6-.3-.1-1.6-.4-2.6-.4-2-.1-3.1.2-4.1.7-1 .4-2.1 1.2-2.7 2v-1.9c0-.3-.2-.5-.5-.5h-4c-.3 0-.5.2-.5.5v23.5c0 .3.2.5.5.5h4.1c.3 0 .5-.2.5-.5V89.9c0-1.6.2-3.2.5-4.1.3-1 .8-1.8 1.4-2.3.6-.6 1.2-1 1.9-1.2s1.5-.3 2.1-.3c.8 0 1.7.2 1.7.2.3 0 .5-.2.6-.4.4-.8 1.2-3 1.3-3.4m-38.9-10.9c-.5-.2-1-.3-1.6-.4s-1.3-.2-2.1-.2c-2.9 0-5.1.8-6.7 2.4s-2.6 4-3.2 7.2l-.2 1.1h-3.6s-.4 0-.5.5l-.6 3.3c0 .3.1.5.5.5h3.5l-3.5 19.7q-.45 2.4-.9 3.9c-.45 1.5-.7 1.7-1.1 2.2s-.8.9-1.4 1.1c-.5.2-1.2.3-1.9.3-.4 0-.9-.1-1.3-.1-.4-.1-.6-.2-.9-.3 0 0-.4-.2-.6.3-.1.3-1.1 2.9-1.2 3.2s0 .6.2.6c.5.2.8.3 1.4.4.9.2 1.6.2 2.3.2q2.25 0 3.9-.6c1.65-.6 2.1-1.1 2.9-2 .9-1 1.5-2.1 2-3.5s1-3.2 1.4-5.3l3.6-20.1h5.2s.4 0 .5-.5l.6-3.3c0-.3-.1-.5-.5-.5h-5c0-.1.3-1.9.8-3.6.2-.7.7-1.3 1.1-1.7s.8-.7 1.3-.8c.5-.2 1.1-.2 1.7-.2.5 0 .9.1 1.3.1.5.1.7.2.8.2.5.2.6 0 .7-.2l1.2-3.3c.3-.4 0-.5-.1-.6m-70.5 34.1c0 .3-.2.5-.5.5H87c-.3 0-.5-.2-.5-.5V68c0-.3.2-.5.5-.5h4.2c.3 0 .5.2.5.5z"></path></g></g></svg>`, 
                'vdc_azure_backup': `<svg class="w-6 h-6" viewBox="0 0 20 20"><defs><linearGradient id="azure_a" x1="9.06" x2="4.143" y1="-209.579" y2="-224.105" gradientTransform="matrix(1 0 0 -1 0 -206)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#114a8b"></stop><stop offset="1" stop-color="#0669bc"></stop></linearGradient><linearGradient id="azure_b" x1="10.595" x2="9.458" y1="-216.348" y2="-216.733" gradientTransform="matrix(1 0 0 -1 0 -206)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-opacity="0.3"></stop><stop offset="0.071" stop-opacity="0.2"></stop><stop offset="0.321" stop-opacity="0.1"></stop><stop offset="0.623" stop-opacity="0.05"></stop><stop offset="1" stop-opacity="0"></stop></linearGradient><linearGradient id="azure_c" x1="10.005" x2="15.403" y1="-209.142" y2="-223.522" gradientTransform="matrix(1 0 0 -1 0 -206)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#3ccbf4"></stop><stop offset="1" stop-color="#2892df"></stop></linearGradient></defs><path fill="url(#azure_a)" d="M7.334 2.462h4.734L7.153 17.024a.76.76 0 0 1-.715.514H2.753a.75.75 0 0 1-.612-.314.76.76 0 0 1-.102-.681l4.58-13.567a.75.75 0 0 1 .715-.514"></path><path fill="#0078d4" d="M14.214 12.229H6.706a.35.35 0 0 0-.324.22.35.35 0 0 0 .086.382l4.824 4.503c.14.131.325.204.517.204h4.251l-1.848-5.308Z"></path><path fill="url(#azure_b)" d="M7.334 2.462a.75.75 0 0 0-.717.523L2.045 16.53a.75.75 0 0 0 .364.923.75.75 0 0 0 .348.084h3.78a.8.8 0 0 0 .62-.527l.912-2.687 3.257 3.037a.78.78 0 0 0 .485.177h4.235l-1.858-5.308H8.773l3.314-9.767H7.335Z"></path><path fill="url(#azure_c)" d="M13.381 2.975a.75.75 0 0 0-.715-.512H7.389a.76.76 0 0 1 .715.512l4.579 13.568a.754.754 0 0 1-.714.995h5.277a.76.76 0 0 0 .612-.314.76.76 0 0 0 .102-.681z"></path></svg>`
            };
            return icons[serviceKey] || `<svg class="w-6 h-6 text-gray-500" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>`;
        }

        function getProviderBadgeColor(provider) {
            if (provider === 'Azure') return 'bg-[#0078D4]';
            if (provider === 'AWS') return 'bg-[#FF9900] text-black';
            return 'bg-slate-600';
        }

        const serviceDisplayNames = {
            'vdc_vault': { short: 'Vault', full: 'VAULT' },
            'vdc_m365': { short: 'M365', full: 'M365 Protection' },
            'vdc_entra_id': { short: 'Entra', full: 'ENTRA ID Protection' },
            'vdc_salesforce': { short: 'SF', full: 'SALESFORCE Protection' },
            'vdc_azure_backup': { short: 'Azure', full: 'AZURE Protection' }
        };

        function getServiceDisplayName(key, type = 'short') {
            const names = serviceDisplayNames[key];
            if (names) return type === 'short' ? names.short : names.full;
            return key.replace('vdc_', '').replace('_', ' ').toUpperCase();
        }

        function hideLoading() {
            const loadingEl = document.getElementById('mapLoading');
            if (loadingEl) loadingEl.classList.add('hidden');
        }

        function showError() {
            const loadingEl = document.getElementById('mapLoading');
            const errorEl = document.getElementById('mapError');
            if (loadingEl) loadingEl.classList.add('hidden');
            if (errorEl) errorEl.classList.add('visible');
        }

        let map;
        try {
            if (typeof L === 'undefined') {
                throw new Error('Leaflet library failed to load');
            }

            map = L.map('map', {
                center: [-25, 140],
                minZoom: 3.0,
                maxZoom: 6.0,
                zoom: 3,
                zoomControl: false,
                worldCopyJump: true,
                maxBoundsViscosity: 1.0,
                maxBounds: [[-60, -185], [90, 185]]
            });
        } catch (e) {
            console.error('Map initialization failed:', e);
            showError();
            throw e;
        }
        
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        const legend = L.control({ position: 'bottomleft' });
        legend.onAdd = function() {
            const div = L.DomUtil.create('div', 'leaflet-bar legend-container');
            div.innerHTML = `
                <div class="bg-slate-800/95 light:bg-white/95 backdrop-blur-sm border border-slate-600/50 light:border-slate-200 rounded-xl px-4 py-3 text-xs shadow-lg">
                    <div class="font-semibold text-slate-400 light:text-slate-500 mb-2.5 uppercase tracking-wider text-[10px]">Providers</div>
                    <div class="flex items-center gap-2.5 mb-2">
                        <span class="w-3.5 h-3.5 rounded-full bg-[#0078D4] border-2 border-white/30 shadow-sm shadow-blue-500/30"></span>
                        <span class="text-white light:text-slate-900 font-medium">Azure</span>
                    </div>
                    <div class="flex items-center gap-2.5">
                        <span class="w-3.5 h-3.5 rounded-full bg-[#FF9900] border-2 border-white/30 shadow-sm shadow-orange-500/30"></span>
                        <span class="text-white light:text-slate-900 font-medium">AWS</span>
                    </div>
                </div>
            `;
            return div;
        };
        legend.addTo(map);

        const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            maxZoom: 19
        });
        
        const lightTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            maxZoom: 19
        });

        let currentTiles = darkTiles;
        currentTiles.addTo(map);

        const systemDarkQuery = window.matchMedia('(prefers-color-scheme: dark)');
        const themeModes = ['system', 'dark', 'light'];
        let currentMode = localStorage.getItem('theme') || 'system';

        function updateIcon(mode) {
            document.getElementById('iconSystem').classList.toggle('hidden', mode !== 'system');
            document.getElementById('iconLight').classList.toggle('hidden', mode !== 'light');
            document.getElementById('iconDark').classList.toggle('hidden', mode !== 'dark');
            
            const titles = { system: 'Theme: System', light: 'Theme: Light', dark: 'Theme: Dark' };
            document.getElementById('themeToggle').title = titles[mode];
        }

        function applyTheme(isLight) {
            const html = document.documentElement;
            
            if (isLight) {
                html.classList.add('light');
                html.classList.remove('dark');
                if (map.hasLayer(darkTiles)) map.removeLayer(darkTiles);
                if (!map.hasLayer(lightTiles)) lightTiles.addTo(map);
                currentTiles = lightTiles;
            } else {
                html.classList.remove('light');
                html.classList.add('dark');
                if (map.hasLayer(lightTiles)) map.removeLayer(lightTiles);
                if (!map.hasLayer(darkTiles)) darkTiles.addTo(map);
                currentTiles = darkTiles;
            }
        }

        function setTheme(mode) {
            currentMode = mode;
            localStorage.setItem('theme', mode);
            updateIcon(mode);
            
            if (mode === 'system') {
                applyTheme(!systemDarkQuery.matches);
            } else {
                applyTheme(mode === 'light');
            }
        }

        document.getElementById('themeToggle').addEventListener('click', () => {
            const nextIndex = (themeModes.indexOf(currentMode) + 1) % themeModes.length;
            setTheme(themeModes[nextIndex]);
        });

        // Listen for system theme changes
        systemDarkQuery.addEventListener('change', (e) => {
            if (currentMode === 'system') {
                applyTheme(!e.matches);
            }
        });

        // Apply saved theme on load (default to system)
        setTheme(currentMode);

        const CLUSTER_CONFIG = {
            MAX_RADIUS: 60,
            DISABLE_AT_ZOOM: 6,
            SPIDERFY_DISTANCE: 1.5
        };

        const CLUSTER_SIZE_THRESHOLDS = {
            MEDIUM: 5,
            LARGE: 20
        };

        const PROVIDER_BAR = {
            MIN_WIDTH: 4,
            MAX_WIDTH: 24
        };

        function createClusterIcon(cluster) {
            const count = cluster.getChildCount();
            const markers = cluster.getAllChildMarkers();
            
            let azureCount = 0;
            let awsCount = 0;
            markers.forEach(m => {
                if (m.options.provider === 'Azure') azureCount++;
                else if (m.options.provider === 'AWS') awsCount++;
            });
            
            let sizeClass = 'cluster-small';
            if (count > CLUSTER_SIZE_THRESHOLDS.LARGE) sizeClass = 'cluster-large';
            else if (count > CLUSTER_SIZE_THRESHOLDS.MEDIUM) sizeClass = 'cluster-medium';
            
            // Minimum 4px width prevents bars from being invisible at high zoom levels or with uneven provider distributions
            const total = azureCount + awsCount;
            const azureWidth = azureCount > 0 ? Math.max(PROVIDER_BAR.MIN_WIDTH, Math.round((azureCount / total) * PROVIDER_BAR.MAX_WIDTH)) : 0;
            const awsWidth = awsCount > 0 ? Math.max(PROVIDER_BAR.MIN_WIDTH, Math.round((awsCount / total) * PROVIDER_BAR.MAX_WIDTH)) : 0;
            
            return L.divIcon({
                html: `<div class="cluster-marker ${sizeClass}">
                    <span>${count}</span>
                    <div class="cluster-providers">
                        ${azureCount > 0 ? `<div class="azure-bar" style="width: ${azureWidth}px"></div>` : ''}
                        ${awsCount > 0 ? `<div class="aws-bar" style="width: ${awsWidth}px"></div>` : ''}
                    </div>
                </div>`,
                className: 'custom-cluster-marker',
                iconSize: L.point(52, 52),
                iconAnchor: L.point(26, 26)
            });
        }

        let clusterGroup = L.markerClusterGroup({
            maxClusterRadius: CLUSTER_CONFIG.MAX_RADIUS,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            disableClusteringAtZoom: CLUSTER_CONFIG.DISABLE_AT_ZOOM,
            iconCreateFunction: createClusterIcon,
            spiderfyDistanceMultiplier: CLUSTER_CONFIG.SPIDERFY_DISTANCE,
            animate: true
        });
        map.addLayer(clusterGroup);

        // Multi-select dropdown logic
        const serviceBtn = document.getElementById('serviceFilterBtn');
        const serviceDropdown = document.getElementById('serviceDropdown');
        const serviceLabel = document.getElementById('serviceFilterLabel');
        const serviceCheckboxes = serviceDropdown.querySelectorAll('input[type="checkbox"]');

        serviceBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = serviceDropdown.classList.toggle('open');
            serviceBtn.setAttribute('aria-expanded', isOpen);
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#serviceMultiselect')) {
                serviceDropdown.classList.remove('open');
                serviceBtn.setAttribute('aria-expanded', 'false');
            }
        });

        function getSelectedServices() {
            const selected = [];
            serviceCheckboxes.forEach(cb => {
                if (cb.checked) selected.push(cb.value);
            });
            return selected;
        }

        function updateServiceLabel() {
            const selected = getSelectedServices();
            if (selected.length === 0) {
                serviceLabel.textContent = 'All Services';
            } else if (selected.length === 1) {
                serviceLabel.textContent = serviceDisplayNames[selected[0]]?.short || selected[0];
            } else {
                serviceLabel.textContent = `${selected.length} selected`;
            }
        }

        serviceCheckboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                updateServiceLabel();
                renderMap();
            });
        });

        function renderMap() {
            clusterGroup.clearLayers();
            let visibleCount = 0;

            const pFilter = document.getElementById('providerFilter').value;
            const selectedServices = getSelectedServices();

            regions.forEach(region => {
                if (!region.coords || !Array.isArray(region.coords)) {
                    console.warn(`Skipping ${region.name}: Missing valid coordinates.`);
                    return; 
                }

                let matchesProvider = (pFilter === 'all' || region.provider === pFilter);
                
                // If no services selected, show all; otherwise region must have ALL selected services
                let matchesService = true;
                if (selectedServices.length > 0) {
                    matchesService = selectedServices.every(svc => region.services && region.services[svc]);
                }

                if (matchesProvider && matchesService) {
                    
                    let iconGrid = '';
                    let serviceList = '';
                    const providerColor = getProviderBadgeColor(region.provider);

                    if (region.services) {
                        Object.keys(region.services).forEach(key => {
                            const serviceValue = region.services[key];
                            
                            iconGrid += `
                                <div class="service-icon-wrapper flex flex-col items-center justify-center w-12 p-1.5 rounded-lg hover:bg-slate-700/30 cursor-default">
                                    ${getServiceIcon(key)}
                                    <span class="text-[9px] mt-1.5 text-slate-400 font-medium uppercase tracking-wide">${getServiceDisplayName(key, 'short')}</span>
                                </div>
                            `;

                            if (serviceValue === true) {
                                serviceList += `
                                    <li class="flex items-center text-xs py-1.5 border-b border-slate-700/50 last:border-0">
                                        <span class="text-slate-300 flex-1 font-medium">
                                            ${getServiceDisplayName(key, 'full')} 
                                        </span>
                                        <span class="text-green-400 ml-2 text-[10px] bg-green-500/10 px-2 py-0.5 rounded-full border border-green-500/30 font-medium">
                                            Available
                                        </span>
                                    </li>
                                `;
                            } else {
                                const configs = ensureArray(serviceValue);
                                configs.forEach(conf => {
                                    if (!conf) return; 

                                    const badgeClass = conf.tier === 'Core' 
                                        ? 'text-blue-400 bg-blue-500/10 border-blue-500/30' 
                                        : 'text-amber-400 bg-amber-500/10 border-amber-500/30';
                                    
                                    serviceList += `
                                        <li class="flex items-center text-xs py-1.5 border-b border-slate-700/50 last:border-0">
                                            <span class="text-slate-300 font-medium flex-1">
                                                ${getServiceDisplayName(key, 'full')} 
                                            </span>
                                            <span class="${badgeClass} ml-2 text-[10px] px-2 py-0.5 rounded-full border font-medium">
                                                ${conf.edition || 'Std'} (${conf.tier || 'N/A'})
                                            </span>
                                        </li>
                                    `;
                                });
                            }
                        });
                    }

                    const popupHTML = `
                        <div class="w-[calc(100vw-60px)] sm:w-80 max-w-80 p-3 sm:p-5 font-sans">
                            <div class="flex justify-between items-start mb-3 sm:mb-4">
                                <h3 class="font-bold text-base sm:text-lg text-white leading-tight pr-2 sm:pr-3">${region.name}</h3>
                                <span class="${providerColor} text-white text-[9px] sm:text-[10px] font-bold px-2 sm:px-2.5 py-0.5 sm:py-1 rounded-md shadow-md flex-shrink-0">
                                    ${region.provider.toUpperCase()}
                                </span>
                            </div>

                            <div class="flex gap-1 mb-3 sm:mb-4 p-2 sm:p-2.5 bg-slate-900/60 rounded-xl border border-slate-700/30 overflow-x-auto -mx-1 px-1" style="scrollbar-width: thin;">
                                ${iconGrid}
                            </div>

                            <div class="bg-slate-800/80 rounded-xl border border-slate-700/50 overflow-hidden shadow-inner">
                                <div class="bg-gradient-to-r from-slate-700/60 to-slate-700/30 px-3 sm:px-3.5 py-1.5 sm:py-2 border-b border-slate-700/50">
                                    <span class="text-[9px] sm:text-[10px] font-semibold text-slate-400 tracking-wider uppercase">Available Services</span>
                                </div>
                                <ul class="px-3 sm:px-3.5 py-2 sm:py-2.5 space-y-0">
                                    ${serviceList}
                                </ul>
                            </div>
                        </div>
                    `;

                    const marker = L.circleMarker(region.coords, {
                        radius: 9,
                        fillColor: region.provider === 'Azure' ? '#0078D4' : '#FF9900',
                        color: region.provider === 'Azure' ? '#60a5fa' : '#fcd34d',
                        weight: 2,
                        opacity: 0.8,
                        fillOpacity: 0.9,
                        provider: region.provider
                    }).bindPopup(popupHTML);

                    marker.on('mouseover', function() {
                        this.setStyle({ radius: 12, weight: 3, opacity: 1 });
                    });
                    marker.on('mouseout', function() {
                        this.setStyle({ radius: 9, weight: 2, opacity: 0.8 });
                    });

                    clusterGroup.addLayer(marker);
                    visibleCount++;
                }
            });

            updateRegionCount(visibleCount, regions.length);
            updateResetButtonVisibility();
        }

        document.getElementById('providerFilter').addEventListener('change', renderMap);

        function updateRegionCount(visible, total) {
            document.getElementById('visibleCount').textContent = visible;
            document.getElementById('totalCount').textContent = total;
            
            const countEl = document.getElementById('visibleCount');
            if (visible < total) {
                countEl.classList.add('text-amber-400');
                countEl.classList.remove('text-white', 'light:text-slate-900');
            } else {
                countEl.classList.remove('text-amber-400');
                countEl.classList.add('text-white', 'light:text-slate-900');
            }
        }

        function hasActiveFilters() {
            const providerFilter = document.getElementById('providerFilter').value;
            const selectedServices = getSelectedServices();
            return providerFilter !== 'all' || selectedServices.length > 0;
        }

        function updateResetButtonVisibility() {
            const resetBtn = document.getElementById('resetFilters');
            if (hasActiveFilters()) {
                resetBtn.classList.remove('hidden');
                resetBtn.classList.add('flex');
            } else {
                resetBtn.classList.add('hidden');
                resetBtn.classList.remove('flex');
            }
        }

        function resetAllFilters() {
            document.getElementById('providerFilter').value = 'all';
            serviceCheckboxes.forEach(cb => cb.checked = false);
            updateServiceLabel();
            renderMap();
        }

        document.getElementById('resetFilters').addEventListener('click', resetAllFilters);

        updateRegionCount(0, regions.length);
        renderMap();

        // Hide loading overlay once tiles are loaded
        currentTiles.once('load', hideLoading);
        setTimeout(hideLoading, 5000);

        // Region search functionality
        const searchInput = document.getElementById('regionSearch');
        const searchResults = document.getElementById('searchResults');
        let highlightedIndex = -1;
        let currentResults = [];

        function setSearchDropdownOpen(isOpen) {
            if (isOpen) {
                searchResults.classList.add('open');
            } else {
                searchResults.classList.remove('open');
            }
            searchInput.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            if (!isOpen) {
                searchInput.setAttribute('aria-activedescendant', '');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function searchRegions(query) {
            if (!query || query.length < 2) return [];
            const q = query.toLowerCase();
            
            return regions
                .map(region => {
                    let matchType = null;
                    let matchText = null;
                    
                    if (region.name.toLowerCase().includes(q)) {
                        matchType = 'name';
                    } else if (region.aliases && Array.isArray(region.aliases) && region.aliases.length > 0) {
                        const matchingAlias = region.aliases.find(a => 
                            a && typeof a === 'string' && a.toLowerCase().includes(q)
                        );
                        if (matchingAlias) {
                            matchType = 'alias';
                            matchText = matchingAlias;
                        }
                    }
                    
                    if (matchType) {
                        return { region, matchType, matchText };
                    }
                    return null;
                })
                .filter(Boolean)
                .slice(0, 10);
        }

        function renderSearchResults(results) {
            currentResults = results;
            highlightedIndex = -1;
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-no-results" role="status">No regions found</div>';
                return;
            }
            
            searchResults.innerHTML = results.map((item, index) => {
                const providerColor = item.region.provider === 'Azure' ? '#0078D4' : '#FF9900';
                const matchInfo = item.matchType === 'alias' ? `<span class="match-text">via "${escapeHtml(item.matchText)}"</span>` : '';
                
                return `
                    <div class="search-result-item" data-index="${index}" id="search-result-${index}" role="option" aria-selected="false">
                        <span class="provider-dot" style="background-color: ${providerColor}"></span>
                        <div>
                            <div class="region-name">${escapeHtml(item.region.name)}</div>
                            ${matchInfo}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectSearchResult(index) {
            if (index < 0 || index >= currentResults.length) return;
            
            const item = currentResults[index];
            const region = item.region;
            const EPSILON = 0.0001;
            
            if (region.coords && Array.isArray(region.coords)) {
                map.setView(region.coords, 5, { animate: true });
                
                clusterGroup.eachLayer(marker => {
                    const markerLat = marker.getLatLng().lat;
                    const markerLng = marker.getLatLng().lng;
                    if (Math.abs(markerLat - region.coords[0]) < EPSILON && 
                        Math.abs(markerLng - region.coords[1]) < EPSILON) {
                        setTimeout(() => marker.openPopup(), 300);
                    }
                });
            }
            
            searchInput.value = '';
            setSearchDropdownOpen(false);
            currentResults = [];
        }

        function updateHighlight(newIndex) {
            const items = searchResults.querySelectorAll('.search-result-item');
            items.forEach(item => {
                item.classList.remove('highlighted');
                item.setAttribute('aria-selected', 'false');
            });
            
            if (newIndex >= 0 && newIndex < items.length) {
                highlightedIndex = newIndex;
                items[newIndex].classList.add('highlighted');
                items[newIndex].setAttribute('aria-selected', 'true');
                items[newIndex].scrollIntoView({ block: 'nearest' });
                searchInput.setAttribute('aria-activedescendant', `search-result-${newIndex}`);
            } else {
                highlightedIndex = -1;
                searchInput.setAttribute('aria-activedescendant', '');
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        if (DEBUG) console.log('Search elements:', { searchInput, searchResults });

        const debouncedSearch = debounce((query) => {
            const results = searchRegions(query);
            if (DEBUG) console.log('Search results:', results);
            renderSearchResults(results);
            setSearchDropdownOpen(true);
        }, 150);

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (DEBUG) console.log('Search query:', query);
            
            if (query.length < 2) {
                setSearchDropdownOpen(false);
                return;
            }
            
            debouncedSearch(query);
        });

        searchInput.addEventListener('keydown', (e) => {
            if (!searchResults.classList.contains('open') || currentResults.length === 0) return;
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                updateHighlight(Math.min(highlightedIndex + 1, currentResults.length - 1));
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                updateHighlight(highlightedIndex - 1);
            } else if (e.key === 'Enter' && highlightedIndex >= 0) {
                e.preventDefault();
                selectSearchResult(highlightedIndex);
            } else if (e.key === 'Escape') {
                setSearchDropdownOpen(false);
                searchInput.blur();
            }
        });

        searchResults.addEventListener('click', (e) => {
            const item = e.target.closest('.search-result-item');
            if (item) {
                selectSearchResult(parseInt(item.dataset.index));
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                setSearchDropdownOpen(false);
            }
        });

        // Info panel logic
        const infoBtn = document.getElementById('infoBtn');
        const infoPanel = document.getElementById('infoPanel');
        const infoPanelOverlay = document.getElementById('infoPanelOverlay');
        const closeInfoPanel = document.getElementById('closeInfoPanel');

        // Get all focusable elements within the panel for focus trapping
        function getFocusableElements() {
            return infoPanel.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
        }

        function openInfoPanel() {
            infoPanelOverlay.classList.remove('hidden');
            requestAnimationFrame(() => {
                infoPanelOverlay.classList.add('open');
                infoPanel.classList.add('open');
            });
            document.getElementById('infoTotalRegions').textContent = regions.length;
            infoBtn.setAttribute('aria-expanded', 'true');
            // Focus the close button after panel opens
            setTimeout(() => closeInfoPanel.focus(), 300);
        }

        function closeInfoPanelFn() {
            infoPanelOverlay.classList.remove('open');
            infoPanel.classList.remove('open');
            infoBtn.setAttribute('aria-expanded', 'false');
            // Restore focus to the info button
            infoBtn.focus();
            setTimeout(() => {
                infoPanelOverlay.classList.add('hidden');
            }, 300);
        }

        infoBtn.addEventListener('click', openInfoPanel);
        closeInfoPanel.addEventListener('click', closeInfoPanelFn);
        infoPanelOverlay.addEventListener('click', closeInfoPanelFn);

        // Keyboard handling: Escape to close, Tab to trap focus
        document.addEventListener('keydown', (e) => {
            if (!infoPanel.classList.contains('open')) return;

            if (e.key === 'Escape') {
                closeInfoPanelFn();
                return;
            }

            // Focus trap within panel
            if (e.key === 'Tab') {
                const focusable = getFocusableElements();
                const firstEl = focusable[0];
                const lastEl = focusable[focusable.length - 1];

                if (e.shiftKey && document.activeElement === firstEl) {
                    e.preventDefault();
                    lastEl.focus();
                } else if (!e.shiftKey && document.activeElement === lastEl) {
                    e.preventDefault();
                    firstEl.focus();
                }
            }
        });

    </script>
    <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "79246557330443bbb5056fbe06a94898"}'></script><!-- End Cloudflare Web Analytics -->
</body>
</html>