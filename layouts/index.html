<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Site.Title }}</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style type="text/tailwindcss">
        @custom-variant dark (&:where(.dark, .dark *));
        @custom-variant light (&:where(.light, .light *));
        
        body { background-color: #0f172a; color: white; }
        .dark body { background-color: #0f172a; color: white; }
        .light body { background-color: #f1f5f9; color: #0f172a; }
        
        #map { height: calc(85vh - 2rem); width: 100%; border-radius: 0.75rem; border: 1px solid #334155; }
        .light #map { border: 1px solid #cbd5e1; }

        /* Leaflet popup - dark mode (default and explicit .dark) */
        .leaflet-popup-content-wrapper {
            background: #1e293b !important;
            color: white !important;
            border: 1px solid #475569 !important;
            padding: 0;
            border-radius: 0.5rem;
        }
        .leaflet-popup-tip {
            background: #1e293b !important;
            border: 1px solid #475569 !important;
        }
        .leaflet-container a.leaflet-popup-close-button {
            color: #94a3b8 !important;
        }
        
        /* Leaflet popup - light mode */
        .light .leaflet-popup-content-wrapper {
            background: white !important;
            color: #0f172a !important;
            border: 1px solid #cbd5e1 !important;
        }
        .light .leaflet-popup-tip {
            background: white !important;
            border: 1px solid #cbd5e1 !important;
        }
        .light .leaflet-container a.leaflet-popup-close-button {
            color: #64748b !important;
        }
        
        .leaflet-popup-content {
            margin: 0 !important;
            width: auto !important;
        }
        
        /* Popup inner content - light mode overrides */
        .light .leaflet-popup-content h3 { color: #0f172a !important; }
        .light .leaflet-popup-content .bg-slate-900\/50 { background: #f1f5f9 !important; border-color: #e2e8f0 !important; }
        .light .leaflet-popup-content .bg-slate-800 { background: #f8fafc !important; }
        .light .leaflet-popup-content .bg-slate-700\/50 { background: #e2e8f0 !important; }
        .light .leaflet-popup-content .border-slate-700 { border-color: #e2e8f0 !important; }
        .light .leaflet-popup-content .border-slate-700\/50 { border-color: #e2e8f0 !important; }
        .light .leaflet-popup-content .text-white { color: #0f172a !important; }
        .light .leaflet-popup-content .text-slate-300 { color: #475569 !important; }
        .light .leaflet-popup-content .text-slate-400 { color: #64748b !important; }
        .light .leaflet-popup-content .text-slate-500 { color: #64748b !important; }
    </style>
</head>
<body class="font-sans antialiased overflow-hidden">

    <div class="h-[15vh] bg-slate-900 light:bg-white border-b border-slate-800 light:border-slate-200 flex flex-col justify-center px-6">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-green-400">Veeam <span class="text-white light:text-slate-900">Service Map</span></h1>
                <p class="text-xs text-slate-400 light:text-slate-500">Interactive Global Availability</p>
            </div>

            <div class="flex gap-3 items-center">
                <select id="providerFilter" class="bg-slate-800 light:bg-white border border-slate-600 light:border-slate-300 rounded px-3 py-2 text-sm text-white light:text-slate-900 focus:ring-2 focus:ring-green-500 outline-none">
                    <option value="all">All Providers</option>
                    <option value="Azure">Azure</option>
                    <option value="AWS">AWS</option>
                </select>

                <select id="serviceFilter" class="bg-slate-800 light:bg-white border border-slate-600 light:border-slate-300 rounded px-3 py-2 text-sm text-white light:text-slate-900 focus:ring-2 focus:ring-green-500 outline-none">
                    <option value="all">All Services</option>
                    <option value="vdc_vault">VDC Vault</option>
                    <option value="vdc_m365">VDC for M365</option>
                    <option value="vdc_salesforce">VDC for Salesforce</option>
                    <option value="vdc_azure_backup">VDC for Azure</option>
                </select>

                <select id="tierFilter" class="bg-slate-800 light:bg-white border border-slate-600 light:border-slate-300 rounded px-3 py-2 text-sm text-white light:text-slate-900 focus:ring-2 focus:ring-green-500 outline-none">
                    <option value="all">All Tiers</option>
                    <option value="Core">Core Regions</option>
                    <option value="Non-Core">Non-Core</option>
                </select>

                <button id="themeToggle" class="p-2 rounded-lg bg-slate-800 light:bg-slate-100 border border-slate-600 light:border-slate-300 hover:bg-slate-700 light:hover:bg-slate-200 transition-colors" title="Toggle theme">
                    <svg id="iconSystem" class="w-5 h-5 text-slate-300 light:text-slate-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l.123.489.804.804A1 1 0 0113 18H7a1 1 0 01-.707-1.707l.804-.804L7.22 15H5a2 2 0 01-2-2V5zm5.771 7H5V5h10v7H8.771z" clip-rule="evenodd"/>
                    </svg>
                    <svg id="iconLight" class="w-5 h-5 text-yellow-400 hidden" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                    </svg>
                    <svg id="iconDark" class="w-5 h-5 text-slate-300 hidden" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div class="p-4 bg-slate-950 light:bg-slate-100">
        <div id="map"></div>
    </div>

    <script>
        // Hugo injects YAML data as JSON; may produce strings instead of arrays in some edge cases
        const rawRegions = [
            {{ range $key, $data := .Site.Data.regions }}
            {
                id: "{{ $key }}",
                name: "{{ $data.name }}",
                provider: "{{ $data.provider }}",
                coords: {{ $data.coords | jsonify }}, 
                services: {{ $data.services | jsonify }} 
            },
            {{ end }}
        ];

        // Normalize data types to handle YAML edge cases like coords: "[-33, 151]" as string
        const regions = rawRegions.map(region => {
            let cleanCoords = region.coords;
            let cleanServices = region.services;

            if (typeof cleanCoords === 'string') {
                try { 
                    cleanCoords = JSON.parse(cleanCoords); 
                } catch(e) {
                    if (cleanCoords.includes(',')) cleanCoords = cleanCoords.split(',').map(Number);
                }
            }

            if (typeof cleanServices === 'string') {
                try { 
                    cleanServices = JSON.parse(cleanServices); 
                } catch(e) { 
                    console.error("Bad JSON in services for:", region.name); 
                    cleanServices = {}; 
                }
            }

            return {
                ...region,
                coords: cleanCoords,
                services: cleanServices || {}
            };
        });

        console.log("Processed Regions Data:", regions);

        function ensureArray(input) {
            if (!input) return [];
            return Array.isArray(input) ? input : [input];
        }

        function getServiceIcon(serviceKey) {
            const icons = {
                'vdc_m365': `<svg class="w-6 h-6 text-[#EA3E23]" fill="currentColor" viewBox="0 0 24 24"><path d="M11.5 12.5H6V7h5.5v5.5zm0 6H6v-5.5h5.5v5.5zm6-6h-5.5V7h5.5v5.5zm0 6h-5.5v-5.5h5.5v5.5z"/></svg>`, 
                'vdc_vault': `<svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>`, 
                'vdc_salesforce': `<svg class="w-6 h-6 text-blue-400" fill="currentColor" viewBox="0 0 24 24"><path d="M19.36 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.64-4.96z"/></svg>`, 
                'vdc_azure_backup': `<svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14h-2v-4H6v-2h4V7h2v4h4v2h-4v4z"/></svg>`
            };
            return icons[serviceKey] || `<svg class="w-6 h-6 text-gray-500" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>`;
        }

        function getProviderBadgeColor(provider) {
            if (provider === 'Azure') return 'bg-[#0078D4]';
            if (provider === 'AWS') return 'bg-[#FF9900] text-black';
            return 'bg-slate-600';
        }

        const map = L.map('map', {
            center: [-25, 140],
            zoom: 3,
            zoomControl: false
        });
        
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        const legend = L.control({ position: 'bottomleft' });
        legend.onAdd = function() {
            const div = L.DomUtil.create('div', 'leaflet-bar legend-container');
            div.innerHTML = `
                <div class="bg-slate-800 light:bg-white border border-slate-600 light:border-slate-300 rounded-lg px-3 py-2 text-xs">
                    <div class="font-bold text-slate-400 light:text-slate-500 mb-2 uppercase tracking-wider">Providers</div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="w-3 h-3 rounded-full bg-[#0078D4] border border-white light:border-slate-300"></span>
                        <span class="text-white light:text-slate-900">Azure</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-[#FF9900] border border-white light:border-slate-300"></span>
                        <span class="text-white light:text-slate-900">AWS</span>
                    </div>
                </div>
            `;
            return div;
        };
        legend.addTo(map);

        const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            maxZoom: 19
        });
        
        const lightTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            maxZoom: 19
        });

        let currentTiles = darkTiles;
        currentTiles.addTo(map);

        const systemDarkQuery = window.matchMedia('(prefers-color-scheme: dark)');
        const themeModes = ['system', 'dark', 'light'];
        let currentMode = localStorage.getItem('theme') || 'system';

        function updateIcon(mode) {
            document.getElementById('iconSystem').classList.toggle('hidden', mode !== 'system');
            document.getElementById('iconLight').classList.toggle('hidden', mode !== 'light');
            document.getElementById('iconDark').classList.toggle('hidden', mode !== 'dark');
            
            const titles = { system: 'Theme: System', light: 'Theme: Light', dark: 'Theme: Dark' };
            document.getElementById('themeToggle').title = titles[mode];
        }

        function applyTheme(isLight) {
            const html = document.documentElement;
            
            if (isLight) {
                html.classList.add('light');
                html.classList.remove('dark');
                if (map.hasLayer(darkTiles)) map.removeLayer(darkTiles);
                if (!map.hasLayer(lightTiles)) lightTiles.addTo(map);
                currentTiles = lightTiles;
            } else {
                html.classList.remove('light');
                html.classList.add('dark');
                if (map.hasLayer(lightTiles)) map.removeLayer(lightTiles);
                if (!map.hasLayer(darkTiles)) darkTiles.addTo(map);
                currentTiles = darkTiles;
            }
        }

        function setTheme(mode) {
            currentMode = mode;
            localStorage.setItem('theme', mode);
            updateIcon(mode);
            
            if (mode === 'system') {
                applyTheme(!systemDarkQuery.matches);
            } else {
                applyTheme(mode === 'light');
            }
        }

        document.getElementById('themeToggle').addEventListener('click', () => {
            const nextIndex = (themeModes.indexOf(currentMode) + 1) % themeModes.length;
            setTheme(themeModes[nextIndex]);
        });

        // Listen for system theme changes
        systemDarkQuery.addEventListener('change', (e) => {
            if (currentMode === 'system') {
                applyTheme(!e.matches);
            }
        });

        // Apply saved theme on load (default to system)
        setTheme(currentMode);

        let markers = [];

        function renderMap() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            const pFilter = document.getElementById('providerFilter').value;
            const sFilter = document.getElementById('serviceFilter').value;
            const tFilter = document.getElementById('tierFilter').value;

            regions.forEach(region => {
                if (!region.coords || !Array.isArray(region.coords)) {
                    console.warn(`Skipping ${region.name}: Missing valid coordinates.`);
                    return; 
                }

                let matchesProvider = (pFilter === 'all' || region.provider === pFilter);
                let matchesService = false;
                
                if (sFilter === 'all') {
                    matchesService = true; 
                } else if (region.services && region.services[sFilter]) {
                    const serviceValue = region.services[sFilter];
                    
                    // Boolean services (vdc_m365: true) have no tiers, so ignore tier filter
                    if (serviceValue === true) {
                        matchesService = (tFilter === 'all');
                    } else {
                        const serviceConfigs = ensureArray(serviceValue);
                        if (tFilter === 'all') {
                            matchesService = true;
                        } else {
                            matchesService = serviceConfigs.some(config => config.tier === tFilter);
                        }
                    }
                }

                if (matchesProvider && matchesService) {
                    
                    let iconGrid = '';
                    let serviceList = '';
                    const providerColor = getProviderBadgeColor(region.provider);

                    if (region.services) {
                        Object.keys(region.services).forEach(key => {
                            const serviceValue = region.services[key];
                            
                            iconGrid += `
                                <div class="flex flex-col items-center justify-center w-10">
                                    ${getServiceIcon(key)}
                                    <span class="text-[9px] mt-1 text-slate-400 font-mono uppercase">${key.replace('vdc_', '').substring(0,4)}</span>
                                </div>
                            `;

                            if (serviceValue === true) {
                                serviceList += `
                                    <li class="flex items-start text-xs py-1 border-b border-slate-700 last:border-0">
                                        <span class="text-slate-300 flex-1">
                                            ${key.replace('vdc_', '').replace('_', ' ').toUpperCase()} 
                                        </span>
                                        <span class="text-green-400 ml-2 text-[10px] bg-slate-800 px-1 rounded border border-slate-700">
                                            Available
                                        </span>
                                    </li>
                                `;
                            } else {
                                const configs = ensureArray(serviceValue);
                                configs.forEach(conf => {
                                    if (!conf) return; 

                                    const isHighlight = (tFilter !== 'all' && conf.tier === tFilter);
                                    const textClass = isHighlight ? "text-green-400 font-bold" : "text-slate-300";
                                    
                                    serviceList += `
                                        <li class="flex items-start text-xs py-1 border-b border-slate-700 last:border-0">
                                            <span class="${textClass} flex-1">
                                                ${key.replace('vdc_', '').replace('_', ' ').toUpperCase()} 
                                            </span>
                                            <span class="text-slate-500 ml-2 text-[10px] bg-slate-800 px-1 rounded border border-slate-700">
                                                ${conf.edition || 'Std'} (${conf.tier || 'N/A'})
                                            </span>
                                        </li>
                                    `;
                                });
                            }
                        });
                    }

                    const popupHTML = `
                        <div class="w-80 p-4 font-sans">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="font-bold text-lg text-white leading-tight pr-2">${region.name}</h3>
                                <span class="${providerColor} text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">
                                    ${region.provider.toUpperCase()}
                                </span>
                            </div>

                            <div class="flex gap-2 mb-4 p-2 bg-slate-900/50 rounded-lg border border-slate-700/50 overflow-x-auto">
                                ${iconGrid}
                            </div>

                            <div class="bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
                                <div class="bg-slate-700/50 px-3 py-1.5 border-b border-slate-700">
                                    <span class="text-[10px] font-bold text-slate-400 tracking-wider uppercase">Available Services</span>
                                </div>
                                <ul class="px-3 py-2 space-y-0">
                                    ${serviceList}
                                </ul>
                            </div>
                        </div>
                    `;

                    const marker = L.circleMarker(region.coords, {
                        radius: 8,
                        fillColor: region.provider === 'Azure' ? '#0078D4' : '#FF9900',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).bindPopup(popupHTML);

                    marker.addTo(map);
                    markers.push(marker);
                }
            });
        }

        document.getElementById('providerFilter').addEventListener('change', renderMap);
        document.getElementById('serviceFilter').addEventListener('change', renderMap);
        document.getElementById('tierFilter').addEventListener('change', renderMap);

        renderMap();

    </script>
</body>
</html>